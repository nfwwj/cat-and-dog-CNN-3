# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1dsBAQig4Wv-boXt1mrh4jRsu343Pr0hG
"""

import streamlit as st
import tensorflow as tf
from tensorflow.keras.models import Sequential, model_from_json
import numpy as np
from tensorflow.keras.preprocessing import image
from PIL import UnidentifiedImageError
from PIL import Image

# json_file = open('catanddog.json', 'r')
# loaded_model_json = json_file.read()
# json_file.close()
# loaded_model = model_from_json(loaded_model_json)

# loaded_model.load_weights("catanddog.h5")
# print("Loaded model from disk")
loaded_model = tf.keras.models.load_model('catanddog.h5')

st.title('Cats and Dogs Classification Using CNN')

# Initialize session state variables
if "ImagePath" not in st.session_state:
    st.session_state.ImagePath = None
if "displayed_image" not in st.session_state:
    st.session_state.displayed_image = None

genre = st.radio("How You Want To Upload Your Image", ('Browse Photos', 'Camera'))

if genre == 'Camera':
    st.session_state.ImagePath = st.camera_input("Take a picture")
elif genre == 'Browse Photos':
    st.session_state.ImagePath = st.file_uploader("Choose a file")

example_images = {
    "Cat": "cat.png",  # Replace with actual paths
    "Dog": "dog.png",  # Replace with actual paths
    "Flower": "flower.png",  # Replace with actual path
}

# HTML/CSS for buttons
st.markdown(
    """
    <style>
    .example-buttons {
        display: flex;
        justify-content: center;
    }
    .example-buttons button {
        margin: 0 10px;
    }
    </style>
    """,
    unsafe_allow_html=True,
)

st.write("Some Try Examples:")

st.markdown("<div class='example-buttons'>", unsafe_allow_html=True)

for image_name, image_path in example_images.items():
    if st.button(image_name):
        st.session_state.ImagePath = image_path
        try:
            st.session_state.displayed_image = Image.open(image_path)
        except Exception as e:
            st.error(f"Error opening image: {e}")
        st.image(st.session_state.displayed_image, width=250)  # Display image

st.markdown("</div>", unsafe_allow_html=True)

st.markdown("---")

if st.button('Predict'):
    if st.session_state.ImagePath is not None:
        try:
            loaded_single_image = tf.keras.utils.load_img(
                st.session_state.ImagePath, color_mode='rgb', target_size=(224, 224)
            )
            test_image = tf.keras.utils.img_to_array(loaded_single_image)
            test_image /= 255

            test_image = np.expand_dims(test_image, axis=0)

            logits = loaded_model(test_image)
            softmax = tf.nn.softmax(logits)

            predict_output = tf.argmax(logits, -1).numpy()
            classes = ['Cat', 'Dog']  # Make sure 'classes' is defined
            st.header(classes[predict_output[0]])

            predicted_class = classes[predict_output[0]]
            probability = softmax.numpy()[0][predict_output[0]] * 100
            st.header(f"Probability of a {predicted_class}: {probability:.4f}%")

            if st.session_state.displayed_image:
                st.image(st.session_state.displayed_image, width=250)  # Redisplay

        except (TypeError, UnidentifiedImageError) as e:
            st.error(f"Invalid file format or error: {e}") #More specific error message
        except Exception as e:
            st.error(f"An error occurred during prediction: {e}")
    else:
        st.header('Please Upload Your File or select an example!!!')
